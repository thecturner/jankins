name: Generate SBOM

on:
  push:
    branches: [master, main]
    tags: ['v*.*.*']
  pull_request:
    branches: [master, main]
  schedule:
    # Generate weekly
    - cron: '0 0 * * 0'

permissions:
  contents: write

jobs:
  sbom:
    name: Generate Software Bill of Materials
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install cyclonedx-bom pip-audit

      - name: Generate CycloneDX SBOM
        run: |
          # Generate SBOM from installed environment
          pip freeze > requirements.txt
          cyclonedx-py requirements \
            -o sbom-cyclonedx.json \
            --of json \
            requirements.txt
        continue-on-error: true

      - name: Generate SPDX SBOM
        run: |
          # Basic SPDX generation (simplified for now)
          echo '{"SPDXID":"SPDXRef-DOCUMENT","spdxVersion":"SPDX-2.3","name":"jankins","dataLicense":"CC0-1.0","creationInfo":{"created":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}}' > sbom-spdx.json
        continue-on-error: true

      - name: Run vulnerability scan on dependencies
        run: |
          pip-audit --format json --output audit-report.json || true
        continue-on-error: true

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom
          path: |
            sbom-cyclonedx.json
            sbom-spdx.json
            audit-report.json
          if-no-files-found: ignore

      - name: Commit SBOMs to repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          mkdir -p .sbom
          # Only move files that exist
          [ -f sbom-cyclonedx.json ] && mv sbom-cyclonedx.json .sbom/ || true
          [ -f sbom-spdx.json ] && mv sbom-spdx.json .sbom/ || true
          git add .sbom/ || true
          git diff --staged --quiet || git commit -m "chore: Update SBOM [skip ci]" || true
          git push || true
        continue-on-error: true
